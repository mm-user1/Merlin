<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strategy Backtester &amp; Optimizer</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
  <div class="pane">
    <div class="split">
      <div class="frame">
        <div class="window backtester-window">
          <div class="title-bar">
            <h2>Backtester</h2>
          </div>
          <div class="content">
            <form id="backtestForm">
              <!-- ============================================ -->
              <!-- STRATEGY SELECTOR -->
              <!-- ============================================ -->
              <div
                class="strategy-selector-section"
                style="margin-bottom: 30px; padding: 20px; background-color: #f0f8ff; border: 2px solid #4a90e2; border-radius: 8px;"
              >
                <h2 style="margin-top: 0; color: #4a90e2;">üìä Select Strategy</h2>

                <div class="form-group">
                  <label style="font-weight: bold;">Strategy:</label>
                  <select
                    id="strategySelect"
                    onchange="handleStrategyChange()"
                    style="padding: 8px; font-size: 14px; min-width: 300px;"
                  >
                    <option value="">Loading strategies...</option>
                  </select>
                </div>

                <div
                  id="strategyInfo"
                  style="margin-top: 15px; padding: 15px; background-color: white; border-radius: 5px; display: none;"
                >
                  <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; font-size: 14px;">
                    <strong>Name:</strong> <span id="strategyName"></span>
                    <strong>Version:</strong> <span id="strategyVersion"></span>
                    <strong>Description:</strong> <span id="strategyDescription"></span>
                    <strong>Parameters:</strong> <span id="strategyParamCount"></span>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="form-group">
                  <div class="checkbox-group">
                    <input type="checkbox" id="dateFilter" />
                    <label for="dateFilter">Date Filter</label>
                  </div>
                  <div class="checkbox-group">
                    <input type="checkbox" id="backtester" />
                    <label for="backtester">Backtester</label>
                  </div>
                </div>

                <div class="form-group">
                  <label for="startDate">Start Date</label>
                  <input type="text" id="startDate" class="date-input" autocomplete="off" />
                  <button type="button" class="calendar-btn" tabindex="-1">üìÖ</button>
                  <input type="text" id="startTime" class="small-input" autocomplete="off" />
                </div>

                <div class="form-group">
                  <label for="endDate">End Date</label>
                  <input type="text" id="endDate" class="date-input" autocomplete="off" />
                  <button type="button" class="calendar-btn" tabindex="-1">üìÖ</button>
                  <input type="text" id="endTime" class="small-input" autocomplete="off" />
                </div>

                <!-- Add after End Time input -->
                <div class="form-group">
                  <label>Warmup Bars:</label>
                  <input
                    type="number"
                    id="warmupBars"
                    name="warmupBars"
                    value="1000"
                    min="100"
                    max="5000"
                    step="100"
                    style="width: 120px;"
                  />
                  <span style="margin-left: 10px; font-size: 12px; color: #666;">
                    (Bars before Start Date for indicator calculation. Recommended: 1000-2000)
                  </span>
                </div>

                <div class="form-group vertical">
                  <label for="csvFile">CSV —Ñ–∞–π–ª (OHLCV)</label>
                  <input type="file" id="csvFile" accept=".csv" multiple />
                  <div id="selectedFilesWrapper" class="selected-files">
                    <div class="selected-files-title">–í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã</div>
                    <ul id="selectedFilesList" class="selected-files-list"></ul>
                  </div>
                </div>

                <div class="form-group">
                  <div class="filter-group" id="exportTradesFilterGroup">
                    <div class="checkbox-group">
                      <input type="checkbox" id="wfExportTrades" />
                      <label for="wfExportTrades">Export Trades</label>
                    </div>
                    <div class="filter-input-group">
                      <label for="wfExportTopK">Top</label>
                      <input
                        type="number"
                        id="wfExportTopK"
                        min="1"
                        max="100"
                        step="1"
                        value="10"
                      />
                    </div>
                  </div>
                </div>
              </div>

              <div class="section">
                <div class="section-title">Optimization Filters</div>
                <div class="form-group">
                  <div class="filter-group" id="minProfitFilterGroup">
                    <div class="checkbox-group">
                      <input type="checkbox" id="minProfitFilter" />
                      <label for="minProfitFilter">Net Profit Filter</label>
                    </div>
                    <div class="filter-input-group">
                      <label for="minProfitThreshold">Min %</label>
                      <input
                        type="number"
                        id="minProfitThreshold"
                        min="0"
                        max="99000"
                        step="1.0"
                        value="0"
                        disabled
                      />
                    </div>
                  </div>
                </div>

                <div class="form-group">
                  <div class="filter-group" id="scoreFilterGroup">
                    <div class="checkbox-group">
                      <input type="checkbox" id="scoreFilter" />
                      <label for="scoreFilter">Score Filter</label>
                    </div>
                    <div class="filter-input-group">
                      <label for="scoreThreshold">Min Score</label>
                      <input
                        type="number"
                        id="scoreThreshold"
                        min="0"
                        max="100"
                        step="0.1"
                        value="60"
                        disabled
                      />
                    </div>
                    <button type="button" class="secondary" id="scoreConfigBtn" style="margin-left: 10px;">‚öôÔ∏è Configure</button>
                  </div>
                </div>

                <div class="collapsible" id="scoreConfigCollapsible">
                  <div class="collapsible-header">
                    <span class="collapsible-icon">‚ñº</span>
                    <span class="section-title" style="margin: 0; border: none;">Score Formula</span>
                  </div>
                  <div class="collapsible-content">
                    <div style="font-size: 12px; color: #5a5a5a; margin-bottom: 10px;">
                      Adjust weights (0.00-1.00) for each metric. Disabled metrics are excluded from Score.
                    </div>

                    <div class="score-formula-params">
                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-romad" checked />
                        <label for="metric-romad" style="min-width: 140px;">RoMaD</label>
                        <input type="number" id="weight-romad" step="0.05" min="0" max="1" value="0.25" style="width: 70px;" />
                        <span style="font-size: 11px; color: #777;">Profit / |MaxDD|</span>
                      </div>

                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-sharpe" checked />
                        <label for="metric-sharpe" style="min-width: 140px;">Sharpe Ratio</label>
                        <input type="number" id="weight-sharpe" step="0.05" min="0" max="1" value="0.20" style="width: 70px;" />
                        <span style="font-size: 11px; color: #777;">Risk-adjusted return</span>
                      </div>

                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-pf" checked />
                        <label for="metric-pf" style="min-width: 140px;">Profit Factor</label>
                        <input type="number" id="weight-pf" step="0.05" min="0" max="1" value="0.20" style="width: 70px;" />
                        <span style="font-size: 11px; color: #777;">Gross Win / Loss</span>
                      </div>

                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-ulcer" checked />
                        <label for="metric-ulcer" style="min-width: 140px;">Ulcer Index</label>
                        <input type="number" id="weight-ulcer" step="0.05" min="0" max="1" value="0.15" style="width: 70px;" />
                        <input type="checkbox" id="invert-ulcer" checked style="margin-left: 8px;" />
                        <label for="invert-ulcer" style="font-size: 11px; min-width: auto;">Invert</label>
                      </div>

                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-recovery" checked />
                        <label for="metric-recovery" style="min-width: 140px;">Recovery Factor</label>
                        <input type="number" id="weight-recovery" step="0.05" min="0" max="1" value="0.10" style="width: 70px;" />
                      </div>

                      <div class="score-metric-row">
                        <input type="checkbox" id="metric-consistency" checked />
                        <label for="metric-consistency" style="min-width: 140px;">Consistency Score</label>
                        <input type="number" id="weight-consistency" step="0.05" min="0" max="1" value="0.10" style="width: 70px;" />
                        <span style="font-size: 11px; color: #777;">Profitable months %</span>
                      </div>
                    </div>

                    <div style="margin-top: 12px; padding: 8px; background: #fff; border: 1px solid #ccc; border-radius: 3px; font-size: 12px;">
                      <strong>Formula Preview:</strong> <span id="formulaPreview">Calculating...</span>
                    </div>

                    <button type="button" class="secondary" id="resetScoreBtn" style="margin-top: 10px;">Reset to Defaults</button>
                  </div>
                </div>
              </div>

              <!-- ============================================ -->
              <!-- DYNAMIC STRATEGY PARAMETERS -->
              <!-- ============================================ -->
              <div id="dynamicParameterForms" style="margin-top: 30px;">
                <h2>Strategy Parameters</h2>

                <!-- Backtest Parameters Container -->
                <div id="backtestParamsContainer" class="params-section">
                  <h3>Backtest Parameters</h3>
                  <div id="backtestParamsContent">
                    <!-- Generated forms will appear here -->
                  </div>
                </div>
              </div>

              
              <div class="section">
                <div class="section-title">Results</div>
                <div id="results" class="results-area">–ù–∞–∂–º–∏—Ç–µ ¬´Run¬ª –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –±—ç–∫—Ç–µ—Å—Ç–∞‚Ä¶</div>
                <div id="error" class="error" role="alert" style="display:none;"></div>
              </div>

              <div class="button-group">
                <div class="preset-dropdown" id="presetDropdown">
                  <button type="button" class="secondary preset-toggle" id="presetToggle">Presets</button>
                  <div class="preset-menu" id="presetMenu" role="menu" aria-hidden="true">
                    <button type="button" class="preset-action" data-action="apply-defaults" role="menuitem">Apply defaults</button>
                    <button type="button" class="preset-action" data-action="save-as" role="menuitem">Save as‚Ä¶</button>
                    <div class="preset-separator"></div>
                    <div class="preset-empty" id="presetEmpty">No saved presets yet</div>
                    <div class="preset-list" id="presetList"></div>
                    <div class="preset-separator"></div>
                    <button type="button" class="preset-action" data-action="save-defaults" role="menuitem">Save as defaults</button>
                    <button type="button" class="preset-action" data-action="import" role="menuitem">Import from CSV‚Ä¶</button>
                    <input type="file" id="presetImportInput" class="preset-import-input" accept=".csv" />
                  </div>
                </div>
                <div style="display: flex; gap: 10px;">
                  <button type="button" class="secondary" id="cancelBtn">Cancel</button>
                  <button type="submit" id="runBtn">Run</button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="frame">
        <div class="window optimizer-window">
          <div class="title-bar">
            <h2>Optimizer Parameters</h2>
          </div>
          <div class="content">
            <div class="left-panel">
              <form id="optimizerForm">
                <div class="info-panel">
                  <div class="info-row">
                    <label for="workerProcesses">Worker processes:</label>
                    <input
                      type="number"
                      id="workerProcesses"
                      name="workerProcesses"
                      min="1"
                      max="32"
                      value="6"
                    />
                  </div>
                </div>

                <div id="optunaSettings" class="collapsible open">
                  <div class="collapsible-header">
                    <span class="collapsible-icon">‚ñº</span>
                    <span class="section-title" style="margin: 0; border: none;">OPTUNA SETTINGS</span>
                  </div>
                  <div class="collapsible-content">
                    <div class="form-group">
                      <label for="optunaTarget">Optimization target:</label>
                      <select id="optunaTarget" style="width: 220px;">
                        <option value="score" selected>Composite Score (recommended)</option>
                        <option value="net_profit">Net Profit %</option>
                        <option value="romad">RoMaD</option>
                        <option value="sharpe">Sharpe Ratio</option>
                        <option value="max_drawdown">Max Drawdown % (minimize)</option>
                      </select>
                    </div>

                    <div class="form-group" style="flex-direction: column; align-items: flex-start; gap: 8px;">
                      <label>Optimization budget:</label>

                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" id="budgetTrials" name="budgetMode" value="trials" checked />
                        <label for="budgetTrials" style="min-width: auto;">Number of trials:</label>
                        <input type="number" id="optunaTrials" min="10" max="10000" value="500" style="width: 80px;" />
                      </div>

                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" id="budgetTime" name="budgetMode" value="time" />
                        <label for="budgetTime" style="min-width: auto;">Time limit:</label>
                        <input type="number" id="optunaTimeLimit" min="1" max="1440" value="60" style="width: 80px;" />
                        <span style="font-size: 13px; color: #5a5a5a;">minutes</span>
                      </div>

                      <div style="display: flex; align-items: center; gap: 8px;">
                        <input type="radio" id="budgetConvergence" name="budgetMode" value="convergence" />
                        <label for="budgetConvergence" style="min-width: auto;">No improvement for:</label>
                        <input type="number" id="optunaConvergence" min="10" max="500" value="50" style="width: 80px;" />
                        <span style="font-size: 13px; color: #5a5a5a;">trials</span>
                      </div>
                    </div>

                    <div class="form-group">
                      <div class="checkbox-group">
                        <input type="checkbox" id="optunaPruning" checked />
                        <label for="optunaPruning">Enable pruning (stop bad trials early)</label>
                      </div>
                    </div>

                    <div
                      style="padding: 10px; background: #e0f3ff; border: 1px solid #90caf9; border-radius: 3px; margin-top: 10px;"
                    >
                      <div style="font-size: 12px; color: #1565c0;">
                        ‚ÑπÔ∏è When using "Composite Score" target, weights are taken from
                        <a href="#" id="linkToScoreConfig" style="color: #0d47a1; text-decoration: underline;">Score Filter configuration</a>
                        in the left panel.
                      </div>
                    </div>

                    <div class="collapsible" style="margin-top: 15px;">
                      <div class="collapsible-header">
                        <span class="collapsible-icon">‚ñº</span>
                        <span class="section-title" style="margin: 0; border: none;">Advanced Settings</span>
                      </div>
                      <div class="collapsible-content">
                        <div class="form-group">
                          <label for="optunaSampler">Sampler:</label>
                          <select id="optunaSampler" style="width: 200px;">
                            <option value="tpe" selected>TPE (recommended)</option>
                            <option value="random">Random</option>
                          </select>
                        </div>

                        <div class="form-group">
                          <label for="optunaPruner">Pruner:</label>
                          <select id="optunaPruner" style="width: 200px;">
                            <option value="median" selected>Median</option>
                            <option value="percentile">Percentile (25%)</option>
                            <option value="patient">Patient (stable)</option>
                            <option value="none">None</option>
                          </select>
                        </div>

                        <div class="form-group">
                          <label for="optunaWarmupTrials">Initial random trials:</label>
                          <input type="number" id="optunaWarmupTrials" min="0" max="50000" value="20" style="width: 80px;" />
                        </div>

                        <div class="form-group">
                          <div class="checkbox-group">
                            <input type="checkbox" id="optunaSaveStudy" />
                            <label for="optunaSaveStudy">Save study database (optuna_study.db)</label>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="section">
                  <div id="optimizerParamsContainer" class="optimizer-params-container">
                    <!-- Parameters will be generated dynamically here -->
                  </div>
                </div>

              </form>
            </div>
          </div>
        </div>
      </div>

      <!-- Third column: Optimizer Run -->
      <div class="frame">
        <div class="window optimizer-run-window">
          <div class="title-bar">
            <h2>Optimizer Run</h2>
          </div>
          <div class="content">
            <!-- Walk-Forward Analysis Section -->
            <div class="wf-section" style="margin-top: 0; padding: 20px; border: 2px solid #3498db; border-radius: 8px; background-color: #f8f9fa;">
              <h3 style="color: #3498db; margin-bottom: 12px;">‚ö° Walk-Forward Analysis</h3>

              <div class="form-group vertical" style="align-items: flex-start;">
                <label style="margin-bottom: 8px;">
                  <input type="checkbox" id="enableWF" onchange="toggleWFSettings()" />
                  <strong>Enable Walk-Forward Optimization</strong>
                </label>
                <p style="font-size: 12px; color: #666; margin: 0;">
                  Splits data into multiple training/testing windows to find robust parameters.
                </p>
              </div>

              <div id="wfSettings" style="display: none; margin-top: 20px;">
                <div class="form-group" style="margin-bottom: 12px;">
                  <label style="min-width: 150px;">Number of Windows:</label>
                  <input type="number" id="wfNumWindows" value="5" min="3" max="10" style="width: 100px;" />
                  <span style="font-size: 12px; color: #666; margin-left: 10px;">(Recommended: 5-6 for 1-2 years of data)</span>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                  <label style="min-width: 150px;">Gap (bars):</label>
                  <input type="number" id="wfGapBars" value="100" min="0" max="500" style="width: 100px;" />
                  <span style="font-size: 12px; color: #666; margin-left: 10px;">(Bars between training and testing to prevent look-ahead bias)</span>
                </div>

                <div class="form-group" style="margin-bottom: 12px;">
                  <label style="min-width: 150px;">Top-K per Window:</label>
                  <input type="number" id="wfTopK" value="20" min="5" max="50" style="width: 100px;" />
                  <span style="font-size: 12px; color: #666; margin-left: 10px;">(Best parameter sets to test on each window)</span>
                </div>

                <div style="background-color: #e8f4f8; padding: 15px; border-radius: 5px;">
                  <strong>Fixed Settings (Stage 1):</strong>
                  <ul style="margin-top: 10px; font-size: 13px; color: #555; padding-left: 18px;">
                    <li>WF Zone: 80% of data</li>
                    <li>Forward Reserve: 20% of data</li>
                    <li>Each window: 70% training (IS), 30% testing (OOS)</li>
                    <li>Rolling window mode</li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="opt-actions" style="margin-top: 20px;">
              <button type="button" id="runOptimizationBtn" onclick="document.getElementById('optimizerForm').requestSubmit()">Run Optimization</button>
            </div>

            <div id="optimizerProgress" style="display: none;">
              <div id="optunaProgress" style="display: none;">
                <div class="progress-bar">
                  <div id="optunaProgressFill" class="progress-fill"></div>
                </div>
                <div id="optunaProgressText">Trial: 0 / 500 (0%)</div>

                <div
                  style="margin-top: 15px; padding: 12px; background: #ffffff; border: 1px solid #cccccc; border-radius: 4px;"
                >
                  <div style="font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #2a2a2a;">Best trial so far:</div>
                  <div id="optunaBestTrial" style="font-size: 12px; color: #2a2a2a; line-height: 1.6;">
                    Waiting for first trial...
                  </div>
                </div>

                <div style="margin-top: 10px; font-size: 12px; color: #5a5a5a;">
                  <span id="optunaCurrentTrial">Current trial: -</span><br />
                  <span id="optunaEta">Est. time remaining: -</span>
                </div>
              </div>
            </div>

            <div id="wfResults" style="display: none; margin-top: 30px;">
              <h3 style="margin-bottom: 15px;">Walk-Forward Results</h3>

              <div id="wfStatus" style="margin-bottom: 15px; font-size: 14px; color: #555;"></div>

              <div id="wfSummary" style="background-color: #d4edda; padding: 15px; border-radius: 5px; margin-bottom: 20px;"></div>

              <h4 style="margin-bottom: 10px;">Top 10 Parameter Sets</h4>
              <table id="wfTable" style="width: 100%; border-collapse: collapse;">
                <thead>
                  <tr style="background-color: #3498db; color: white;">
                    <th style="padding: 10px; border: 1px solid #ddd;">Rank</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Param ID</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Appearance</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Avg OOS Profit %</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">OOS Win Rate</th>
                    <th style="padding: 10px; border: 1px solid #ddd;">Forward Profit %</th>
                  </tr>
                </thead>
                <tbody id="wfTableBody"></tbody>
              </table>

              <div style="margin-top: 20px; font-size: 14px; color: #666;">
                Full detailed results will be automatically downloaded as CSV.
              </div>
            </div>

            <div id="optimizerResults" class="results-area" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- JavaScript modules -->
  <script src="/static/js/utils.js"></script>
  <script src="/static/js/api.js"></script>
  <script src="/static/js/strategy-config.js"></script>
  <script src="/static/js/presets.js"></script>
  <script src="/static/js/ui-handlers.js"></script>
  <script src="/static/js/main.js"></script>
</body>
</html>
