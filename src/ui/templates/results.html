<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Strategy Backtester &amp; Optimizer - Results</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>
<body>
  <nav class="top-nav">
    <div class="nav-tabs">
      <a href="/" class="nav-tab" data-nav="start">Start</a>
      <a href="/results" class="nav-tab active" data-nav="results">Results</a>
    </div>
    <div class="nav-spacer"></div>
  </nav>

  <div class="main-container">
    <div class="sidebar">
      <div class="collapsible open">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">Studies Manager</span>
        </div>
        <div class="collapsible-content studies-manager">
          <div class="studies-list">
          </div>

          <div class="manager-buttons">
            <button class="manager-btn" id="studySelectBtn">Select</button>
            <button class="manager-btn delete-btn" id="studyDeleteBtn">Delete</button>
          </div>
        </div>
      </div>

      <div class="collapsible open">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">Status &amp; Controls</span>
        </div>
        <div class="collapsible-content">
          <div class="status-row">
            <span class="status-badge idle" id="statusBadge">Idle</span>
            <div class="control-buttons">
              <button class="control-btn pause">Pause</button>
              <button class="control-btn stop">Stop</button>
              <button class="control-btn cancel">Cancel</button>
            </div>
          </div>

          <div class="progress-compact">
            <div class="progress-bar-small">
              <div class="progress-fill-small" style="width: 0%"></div>
            </div>
            <div class="progress-info">
              <span id="progressLabel">Trial 0 / 0</span>
              <span id="progressPercent">0%</span>
            </div>
          </div>
        </div>
      </div>

      <div class="collapsible open" id="wfa-progress-section" style="display: none;">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">Walk-Forward Progress</span>
        </div>
        <div class="collapsible-content">
          <div class="settings-list">
            <div class="setting-item">
              <span class="key">Current Window</span>
              <span class="val" id="wfa-current-window">- / -</span>
            </div>
            <div class="setting-item">
              <span class="key">Phase</span>
              <span class="val" id="wfa-phase">-</span>
            </div>
          </div>
          <div class="window-indicator"></div>
        </div>
      </div>

      <div class="collapsible open">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">Optuna Settings</span>
        </div>
        <div class="collapsible-content">
          <div class="settings-list">
            <div class="setting-item">
              <span class="key">Objectives</span>
              <span class="val" id="optuna-objectives">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Primary</span>
              <span class="val" id="optuna-primary">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Constraints</span>
              <span class="val" id="optuna-constraints">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Budget</span>
              <span class="val" id="optuna-budget">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Sampler</span>
              <span class="val" id="optuna-sampler">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Pruner</span>
              <span class="val" id="optuna-pruner">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Sanitize Trades</span>
              <span class="val" id="optuna-sanitize">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Filter</span>
              <span class="val" id="optuna-filter">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Workers</span>
              <span class="val" id="optuna-workers">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Optimization Time</span>
              <span class="val" id="optuna-time">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="collapsible" id="wfa-settings-section" style="display: none;">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">WFA Settings</span>
        </div>
        <div class="collapsible-content">
          <div class="settings-list">
            <div class="setting-item">
              <span class="key">IS (days)</span>
              <span class="val" id="wfa-is-days">-</span>
            </div>
            <div class="setting-item">
              <span class="key">OOS (days)</span>
              <span class="val" id="wfa-oos-days">-</span>
            </div>
          </div>
        </div>
      </div>

      <div class="collapsible open">
        <div class="collapsible-header">
          <span class="collapsible-icon">&#9660;</span>
          <span class="collapsible-title">Strategy</span>
        </div>
        <div class="collapsible-content">
          <div class="settings-list">
            <div class="setting-item">
              <span class="key">Name</span>
              <span class="val" id="strategy-name">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Version</span>
              <span class="val" id="strategy-version">-</span>
            </div>
            <div class="setting-item">
              <span class="key">Data</span>
              <span class="val" id="strategy-dataset">-</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="main-area">
      <div class="results-header">
        <h2>Optimization Results</h2>
        <div class="header-actions">
          <button class="btn btn-secondary" id="manualTestBtn">Manual Test</button>
          <button class="btn btn-secondary" id="downloadTradesBtn">Download Trades</button>
        </div>
      </div>

      <div class="chart-card">
        <div class="chart-card-header">
          <h3>Equity Curve</h3>
        </div>
        <div class="chart-body">
          <div class="chart-canvas">
            <svg class="chart-svg" viewBox="0 0 800 260" preserveAspectRatio="none">
              <text x="400" y="130" text-anchor="middle" fill="#999" font-size="14">
                No data to display
              </text>
            </svg>
            <div class="comparison-line" id="comparisonLine" style="display: none;"></div>
          </div>
          <div class="chart-axis" id="equityAxis"></div>
        </div>
      </div>

      <div class="summary-row" style="display: none;"></div>

      <div class="results-tabs" id="resultsTabs">
        <button class="tab-btn active" data-tab="optuna">Optuna IS</button>
        <button class="tab-btn" data-tab="dsr" style="display: none;">DSR</button>
        <button class="tab-btn" data-tab="forward_test" style="display: none;">Forward Test</button>
        <button class="tab-btn" data-tab="stress_test" style="display: none;">Stress Test</button>
        <button class="tab-btn" data-tab="oos_test" style="display: none;">OOS Test</button>
        <button class="tab-btn" data-tab="manual_tests" style="display: none;">Test Results</button>
      </div>

      <div class="table-card">
      <div class="table-card-header">
        <div class="table-header-left">
          <h3 id="resultsTableTitle">Optuna IS</h3>
          <span id="resultsTableSubtitle" style="font-size: 12px; color: #777;">Sorted by objectives</span>
        </div>
        <div class="test-results-controls" id="testResultsControls" style="display: none;">
          <label for="manualTestSelect">Test:</label>
          <select id="manualTestSelect"></select>
          <button class="btn btn-secondary" id="manualTestDelete">Delete</button>
          <span class="baseline-label" id="manualTestBaselineLabel"></span>
        </div>
      </div>
        <div class="table-scroll">
          <table class="data-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Param ID</th>
                <th>Net Profit %</th>
                <th>Max DD %</th>
                <th>Trades</th>
                <th>Score</th>
                <th>RoMaD</th>
                <th>Sharpe</th>
                <th>PF</th>
                <th>Ulcer</th>
                <th>SQN</th>
                <th>Consist</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="table-expand">
          <button class="table-expand-toggle" id="tableExpandToggle" type="button" aria-label="Expand table"></button>
        </div>
      </div>

      <div class="param-details-section" id="paramDetailsSection">
        <div class="param-details-card">
          <div class="param-details-header" id="paramDetailsTitle">
            Parameter Details
          </div>
          <div class="param-details-body">
            <div class="param-details-grid" id="paramDetailsContent"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/js/utils.js"></script>
  <script src="/static/js/api.js"></script>
  <script src="/static/js/optuna-results-ui.js"></script>
  <script src="/static/js/wfa-results-ui.js"></script>
  <script src="/static/js/post-process-ui.js"></script>
  <script src="/static/js/results.js"></script>

  <div class="modal-overlay" id="missingCsvModal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Market Data File Not Found</h3>
      </div>
      <div class="modal-body">
        <p><strong>File:</strong> <span id="missingCsvName">Unknown</span></p>
        <p><strong>Original path:</strong> <span id="missingCsvPath">Unknown</span></p>
        <p class="modal-note">Select the CSV file or paste a new path to continue.</p>
        <input type="file" id="missingCsvFile" accept=".csv" />
        <input type="text" id="missingCsvInput" placeholder="Or paste CSV path" />
      </div>
      <div class="modal-actions">
        <button class="btn btn-primary" id="missingCsvUpdate">Update</button>
        <button class="btn btn-secondary" id="missingCsvCancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="manualTestModal">
    <div class="modal-card">
      <div class="modal-header">
        <h3>Test Parameters on New Data</h3>
      </div>
      <div class="modal-body">
        <div class="modal-section">
          <strong>Data Source</strong>
          <div class="radio-row">
            <label>
              <input type="radio" name="manualDataSource" id="manualDataOriginal" value="original_csv" checked />
              Original CSV
            </label>
            <label>
              <input type="radio" name="manualDataSource" id="manualDataNew" value="new_csv" />
              New CSV
            </label>
          </div>
          <input type="file" id="manualDataFile" accept=".csv" />
        </div>

        <div class="modal-section">
          <strong>Date Range</strong>
          <div class="form-group">
            <label for="manualStartDate">Start:</label>
            <input type="text" id="manualStartDate" class="date-input" autocomplete="off" value="2025-06-15" />
            <label for="manualEndDate">End:</label>
            <input type="text" id="manualEndDate" class="date-input" autocomplete="off" value="2025-11-15" />
          </div>
        </div>

        <div class="modal-section">
          <strong>Trials to Test</strong>
          <div class="radio-row">
            <label>
              <input type="radio" name="manualTrialMode" id="manualTrialTop" value="top" checked />
              Top Rank
            </label>
            <input type="number" id="manualTopK" value="10" min="1" max="10000" style="width: 80px;" />
          </div>
          <div class="radio-row">
            <label>
              <input type="radio" name="manualTrialMode" id="manualTrialSelected" value="selected" />
              Use Selected
            </label>
            <span id="manualSelectedLabel">Trial # -</span>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn btn-secondary" id="manualTestCancel">Cancel</button>
        <button class="btn btn-primary" id="manualTestRun">Run Test</button>
      </div>
    </div>
  </div>
</body>
</html>
