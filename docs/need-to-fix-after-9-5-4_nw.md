# Need-to-fix After 9-5-4

Validated against `docs/prompt_9-5-3_refactor_audit.md` and `docs/prompt_9-5-4_refactor_audit.md`; each item below is still present in code (line hints included).

- **Legacy feature flag scaffold in backend** — `src/server.py` still contains `_get_strategy_features()` and MA-group validation branches (lines ~41-74, 1085-1143, 1307-1336). Configs dropped `features`, so this code is dead but still executes. *Fix:* Delete `_get_strategy_features`, remove MA-group checks, and rely on `_get_parameter_types()` as the single config-driven source of parameter metadata.
- **Optimizer payload MA handling still S01-specific in server** — Optimization request building uppercases `ma_types_trend/trail_*` and expects MA groups (lines ~1451-1453). This blocks non-S01 select params. *Fix:* Treat all select parameters generically: accept optimizer selections directly from the config-driven UI, drop special casing/uppercasing of MA lists, and pass selected options via a generic `param_types/param_ranges` contract.
- **OptimizationConfig carries S01-only fields** — `src/core/optuna_engine.py` defines `ma_types_trend`, `ma_types_trail_long`, `ma_types_trail_short`, `lock_trail_types`, `atr_period` (lines ~24-53). These break optimizer for other strategies. *Fix:* Remove these fields; derive selectable options and any locking rules from each strategy `config.json`; keep only generic fields (`enabled_params`, `param_ranges`, `param_types`, `fixed_params`, etc.).
- **Hardcoded MA logic in Optuna engine** — Sections around lines ~360-410, 420-421, 565-568 in `optuna_engine.py` special-case MA selection. *Fix:* Generate search space from `param_types` + `param_ranges`, treating select parameters by their option lists; delete MA-specific branches and lock logic; rely on config-driven options.
- **Walkforward engine assumes S01 params** — `src/core/walkforward_engine.py` references `ma_types_trend` and formats param names with `maType/maLength` (e.g., lines ~447, 585-594, 1050). *Fix:* Remove S01 assumptions; build parameter labels/ranges from strategy config and the generic optimizer/walkforward config; avoid hardcoded MA naming.
- **Optimizer UI still hardcoded to S01** — Frontend optimizer form is not fully config-driven and keeps S01-specific MA selectors/payload assembly (e.g., `src/index.html` lines ~419-537, 1870-2024, 2930-2947, 3519-3532). *Fix:* Reuse the generic parameter rendering used for backtests to build optimizer controls from `config.json` (including select-type multi-choice), eliminating hardcoded HTML/JS for S01 fields.
- **Missing client-side validation for optimizer ranges** — Optimizer form does not enforce `from < to`, positive step, or config min/max. *Fix:* Add a validation layer before submission that checks range ordering, positive step, and respects config bounds; block submit with clear errors.
- **Inline CSS remains in index.html** — Styles live in `<style>` (index.html lines ~8-48). *Fix:* Move remaining inline CSS into `static/css/style.css` and import there to prep for Phase 8/10 separation.
- **Frontend tests absent** — No automated tests guard `createFormField`, `generateOptimizerForm`, or value collection. *Fix:* Add Jest (or similar) tests covering numeric constraints, select option rendering, optimizer grouping, and validation outcomes to prevent regressions during optimizer/UI refactors.
- **Regression test report too thin** — `tests/REGRESSION_TEST_REPORT.md` lacks breakdown and metrics. *Fix:* Expand with per-suite counts, timing, dataset notes, and comparison vs prior runs to make audits reproducible.
- **Frontend remains monolithic** — All HTML, CSS, and JS live in `src/index.html` (~3800 lines), noted as technical debt in 9-5-3. *Fix:* Split into modules (e.g., `static/js/api.js`, `static/js/forms.js`, `static/js/optimizer.js`) and move styling to CSS; wire via imports/bundling to support future UI work.
