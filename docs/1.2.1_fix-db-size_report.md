# 1.2.1 Fix DB Size Report

**Date:** 2026-02-03
**Scope:** `+Merlin/+Merlin-GH`

## Problem Summary
The SQLite database size was dominated by WFA per-window equity curves and timestamps (IS + OOS), stored at bar-level resolution. This produced large JSON blobs per window, even though most of that data is rarely accessed. The target was to reduce storage while preserving functional behavior: stitched OOS chart remains visible, per-window equity remains available on-demand, and metrics remain accurate.

## High-Level Solution
1. **Store only stitched OOS equity in a compact, event-based format** (trade exits + window boundary anchors).
2. **Stop persisting IS/OOS per-window equity and timestamps** in `wfa_windows` (still generated on-demand via CSV).
3. **Keep metrics accurate** by computing stitched metrics from the dense (bar-level) curves during WFA execution, but store/display the compact curve.
4. **Expose stitched OOS from DB to the UI**, with a safe fallback to the legacy stitched-from-windows behavior for older studies.

## Key Logic and Targets
- **Compact stitched curve** is derived from OOS realized balance at:
  - OOS window start (anchor)
  - OOS window end (anchor)
  - Each trade exit timestamp
- **Stitched metrics** (net profit, max drawdown) are still calculated from the dense curve, preserving accuracy.
- **Per-window equity curves** are no longer persisted; they are computed on-demand via existing CSV-based endpoints.

## Implementation Details
### Database Schema (studies table)
Added columns to persist compact stitched OOS and its metrics:
- `stitched_oos_equity_curve`
- `stitched_oos_timestamps_json`
- `stitched_oos_window_ids_json`
- `stitched_oos_net_profit_pct`
- `stitched_oos_max_drawdown_pct`
- `stitched_oos_total_trades`
- `stitched_oos_win_rate`

Migration is handled via `_ensure_columns` so existing DBs are updated automatically.

### WFA Execution and Stitching
- **Dense and compact curves are built in parallel**.
- **Metrics** use the dense curve.
- **Stored/returned curve** uses the compact curve.

### UI Behavior
- Results page now **prefers stitched data from DB** when present.
- **Fallback** to legacy stitched-from-windows for older studies.

### Storage Behavior
- `wfa_windows.is_equity_curve`, `wfa_windows.oos_equity_curve`, `is_timestamps_json`, `oos_timestamps_json` are now saved as `NULL` for new studies.

## Files Updated
- `src/core/walkforward_engine.py`
  - Added compact stitched builder and dual dense/compact stitching.
  - Preserved accurate metrics with dense curves.
- `src/core/storage.py`
  - Added stitched columns to schema and migrations.
  - Persisted compact stitched curve + metrics in `studies`.
  - Stopped storing per-window equity/timestamps.
  - Exposed stitched data in `load_study_from_db`.
- `src/ui/static/js/results-controller.js`
  - Prefer stored stitched from DB; fallback to legacy stitched-from-windows.
- `tests/test_storage.py`
  - Added schema checks for stitched columns.

## Test Results
Command executed:
```
py -3 -m pytest tests/test_walkforward.py tests/test_storage.py tests/test_server.py -v
```
Result:
- **28 passed**

The reference dataset `data/raw/OKX_LINKUSDT.P, 15 2025.05.01-2025.11.20.csv` was used by integration tests.

## Errors / Deviations
- Initial test run failed due to misplaced stitched variable initialization in `save_wfa_study_to_db`. Fixed by moving stitched serialization into the correct scope and removing accidental insertion in `save_oos_test_results`. All tests passed afterward.

## Outcome
The update significantly reduces DB growth for WFA studies by:
- Eliminating per-window equity/timestamp storage
- Persisting only compact stitched OOS data

All required functionality remains intact:
- Stitched OOS chart is available without CSV
- Window IS/OOS equity is generated on demand
- Metrics remain accurate

## Follow-up UI Fix (Stitched OOS Window Boundaries)
After the compact stitched curve change, the Stitched OOS chart started showing window boundaries that looked misaligned with dates. Investigation showed:
- Stored boundaries are correct (OOS start dates match stored stitched timestamps).
- The chart X-axis was still index-based, which distorts time when the curve is sparse (points only at trade exits).

### Fix Applied
Only the **Stitched OOS** chart now uses a **time-based X scale** derived from its timestamps. All other charts remain index-based.

Implementation changes:
- `renderEquityChart()` now accepts `{ useTimeScale: true }` and maps X by timestamp when provided.
- Stitched OOS boundaries are built from window `oos_start_date` and rendered on the same time scale.
- The initial WFA render path (`refreshResultsView`) was updated to use the same time-scale logic; previously it still used index-based boundaries on load.

This restores correct visual alignment of window boundaries without changing storage or non-stitched charts.

### Tests
No additional automated tests were run for this UI-only adjustment.
