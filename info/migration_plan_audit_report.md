# Audit отчёт по плану миграции

## Общая оценка реализуемости
План детализирован по фазам и соответствует целевой архитектуре с явным ядром, библиотекой индикаторов, централизованными метриками/экспортом и разделённым UI. Целевое дерево каталогов и роли модулей чётко описаны и достижимы при поэтапной реализации.【F:info/PROJECT_MIGRATION_PLAN.md†L10-L181】【F:info/PROJECT_STRUCTURE.md†L6-L101】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L10-L389】

Проект рассчитан на единственного пользователя и локальное использование, поэтому риски совместимости/масштабирования минимальны. Ключевые риски связаны только с сохранением корректности вычислений и сопоставимостью метрик.

## Сложность и риски по фазам
- **Пред-фаза (pytest baseline).** Простая и низкорисковая, нужна только настройка инфраструктуры тестов и минимальный sanity-тест.【F:info/PROJECT_MIGRATION_PLAN.md†L21-L58】
- **Фаза 0 (регрессия S_01).** Средняя сложность: нужно подготовить baseline-датасет и автоматизировать сравнение метрик/сделок. Это критично для последующих проверок корректности, но трудоёмкость умеренная.【F:info/PROJECT_MIGRATION_PLAN.md†L39-L58】
- **Фаза 1 (разделение фронтенда).** Низкий риск: чистое разбиение HTML/CSS/JS без изменения поведения. Требуется ручной smoke-тест UI.【F:info/PROJECT_MIGRATION_PLAN.md†L62-L77】
- **Фаза 2 (выделение ядра + отказ от Grid Search).** Средний риск: массовое перемещение файлов и импортов. Основные сложности — устранить зависимости `optuna_engine` от `optimizer_engine` и корректно обновить сервер/CLI. После удаления Grid Search важно убедиться, что Optuna покрывает все сценарии.【F:info/PROJECT_MIGRATION_PLAN.md†L80-L138】
- **Фаза 3 (пакет индикаторов).** Средний риск: потребуется выявить и декомпозировать все индикаторные функции, добавить fallback в `BaseStrategy` и обновить ссылки во всех стратегиях и движках. Возможны off-by-one ошибки в расчётах при переносе функций, поэтому нужна регрессия S_01.【F:info/PROJECT_MIGRATION_PLAN.md†L141-L180】
- **Фаза 4 (метрики + unit-тесты).** Высокий риск: перенос метрик в отдельный модуль может изменить результаты. Требуется тесная интеграция с backtest/Optuna/WFA и обязательная регрессия. Наличие целевых API для `BasicMetrics/AdvancedMetrics/WFAMetrics` хорошо описано в целевой архитектуре и облегчает реализацию.【F:info/PROJECT_MIGRATION_PLAN.md†L184-L218】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L188-L222】
- **Фаза 5 (экспорт).** Средний риск: перенос CSV-логики в `export.py` требует проверки форматов, особенно для TradingView/Optuna/WFA. Архитектурное описание ясно очерчивает ответственность модуля.【F:info/PROJECT_MIGRATION_PLAN.md†L220-L248】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L225-L245】
- **Фаза 6 (простая стратегия).** Низкий риск: хорошая практика для обкатки новой архитектуры. Помогает проверить цепочки движков/метрик/экспорта без сложностей S_01.【F:info/PROJECT_MIGRATION_PLAN.md†L250-L289】
- **Фаза 7 (миграция S_01).** Высокий риск: требует параллельного существования legacy и новой версии, тщательного сравнения метрик и сделок, а также чистого переключения в UI/ядре. План корректно предусматривает дубль и пошаговое удаление legacy.【F:info/PROJECT_MIGRATION_PLAN.md†L291-L370】
- **Фаза 8 (логирование и чистка).** Низкий риск: финальная унификация и документация. Предлагаемый флаг логирования в CLI уместен, а чистка legacy-кода завершает переход.【F:info/PROJECT_MIGRATION_PLAN.md†L372-L412】

## Соответствие целевой структуре
- План миграции полностью отражает целевую структуру каталогов и слоёв, описанную в `PROJECT_STRUCTURE` и `PROJECT_TARGET_ARCHITECTURE`: три движка в `src/core/`, библиотека индикаторов, единые модули `metrics.py` и `export.py`, стратегии с единым контрактом и конфигами, фронт отдельно от логики.【F:info/PROJECT_STRUCTURE.md†L35-L101】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L10-L389】
- Рекомендация объявлять структуры данных (TradeRecord, StrategyResult, Basic/Advanced/WFA Metrics) внутри профильных модулей совпадает между планом и целевой архитектурой, что исключает дублирование типов.【F:info/PROJECT_MIGRATION_PLAN.md†L10-L18】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L68-L88】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L188-L215】

## Потенциальные узкие места и предложения по улучшению
1. **Тестовая матрица.** Дополнить базовый pytest smoke (пред-фаза) фиктивными тестами на загрузку конфигов стратегий и доступность индикаторов после переноса, чтобы раннее выявлять разрывы импортов.【F:info/PROJECT_MIGRATION_PLAN.md†L21-L58】【F:info/PROJECT_STRUCTURE.md†L26-L33】
2. **Контроль форматов данных.** Для фаз 3–5 добавить мини-спеки форматов (CSV для TV/Optuna/WFA, структура `StrategyResult`) рядом с кодом или в `docs/`, чтобы при переносе не возникало несогласованностей форматов экспорта/метрик.【F:info/PROJECT_MIGRATION_PLAN.md†L141-L248】【F:info/PROJECT_STRUCTURE.md†L12-L16】
3. **Библиотека индикаторов.** При переносе индикаторов зафиксировать минимальные наборы тестовых входов/ожидаемых выходов (например, EMA/ATR) и использовать их в `tests/test_indicators.py` для предотвращения регрессий при рефакторинге формул.【F:info/PROJECT_MIGRATION_PLAN.md†L141-L180】
4. **Переиспользование кода между Optuna/WFA.** В фазе 4–5 можно выделить общее API для подготовки `StrategyParams` и расчёта score, чтобы WFA использовала тот же код, что и Optuna, минимизируя расхождения в метриках и параметрах запуска.【F:info/PROJECT_MIGRATION_PLAN.md†L184-L248】【F:info/PROJECT_TARGET_ARCHITECTURE.md†L101-L185】
5. **Миграция S_01.** До начала фазы 7 стоит заранее подготовить список особенностей legacy S_01 (используемые индикаторы, порядок сигналов, специфика комиссий/размера позиции) — это ускорит поиск расхождений при сравнении дубля. Желательно автоматизировать сравнение сделок по времени/бару через экспортные CSV.【F:info/PROJECT_MIGRATION_PLAN.md†L291-L370】
6. **Логирование.** В фазе 8 имеет смысл определить единый формат сообщений (уровень, идентификатор стратегии, окно WFA/трейл Optuna) и минимальный набор логов для трёх движков, чтобы облегчить локальный анализ без перегрузки логами.【F:info/PROJECT_MIGRATION_PLAN.md†L372-L412】

## Итог
План миграции реалистичен и детализирован, фазы расположены в логичном порядке наращивания архитектуры и контроля качества. Основные риски сосредоточены в переносе индикаторов/метрик и миграции S_01; они уже помечены как high-risk и требуют регрессионных проверок. Предложенные дополнения (расширенная тестовая матрица, фиксация форматов, единые утилиты для Optuna/WFA и более строгая подготовка к миграции S_01) помогут уменьшить трудозатраты и упростить верификацию результатов при сохранении простоты для личного использования.
